<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>WÆŽNDER</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    /* Minimal style overrides for profile display */
    #profile-display {
      display: flex;
      align-items: center;
      gap: 15px;
      color: white;
      cursor: pointer;
    }
    #profile-display span {
      font-weight: bold;
    }
    #redeemCashbackBtn {
      background: #0f62fe;
      color: white;
      border: none;
      padding: 5px 10px;
      cursor: pointer;
      border-radius: 4px;
    }
    #redeemCashbackBtn:hover {
      background: #0353e9;
    }
    /* Popup fixes */
    .popup-box form input {
      display: block;
      margin: 10px 0;
      width: 90%;
      padding: 8px;
    }
    .popup-box form button {
      margin-top: 10px;
      padding: 10px 15px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header class="header">
    <h1 class="logo-text" id="logo-click" style="cursor: pointer;">WÆŽNDER</h1>
    <nav class="nav-links">
      <a href="#" id="store-link">Store</a>
      <a href="#" id="gambling-link">Gambling</a>
    </nav>

    <!-- Login button (default) -->
    <button id="open-auth-popup" class="login-btn">Login</button>

    <!-- Profile display (hidden by default) -->
    <div id="profile-display" style="display:none;">
      <span id="profileName"></span>
      <span>Balance: <span id="profileBalance"></span></span>
      <span>Level: <span id="profileLevel"></span></span>
      <span>XP: <span id="profileXP"></span></span>
      <span>Cashback: <span id="profileCashback"></span></span>
      <button id="redeemCashbackBtn" style="display:none;">Redeem Cashback</button>
      <button id="logoutBtn">Logout</button>
    </div>
  </header>

  <main class="content">
    <!-- Home Section (default) -->
    <section id="home-section" class="section">
      <p style="text-align:center; margin-top: 100px; font-size: 1.4rem;">
        ðŸ‘‹ Welcome to <strong>WÆŽNDER Web</strong><br />Your gateway to unique services and games.
      </p>
    </section>

    <!-- Store Section -->
    <section id="store-section" class="section hidden">
      <h2>Store</h2>
      <div class="product">
        <h3>Custom Discord Bot</h3>
        <p><strong>Price:</strong> â‚¬5</p>
        <p><strong>In Stock:</strong> Unlimited</p>
        <button class="buy-btn">Buy</button>
      </div>
    </section>

    <!-- Gambling Section -->
    <section id="gambling-section" class="section hidden">
      <h2>Mines Game</h2>
      <p>
        Choose between 1 and 24 mines on a 5x5 grid.<br />
        Bet from â‚¬0.10 up to â‚¬10,000.<br />
        Click safe tiles and cash out any time to win!
      </p>
      <button class="play-btn">Play Mines</button>
    </section>
  </main>

  <footer class="footer">
    <p>&copy; 2025 WÆŽNDER. All rights reserved.</p>
  </footer>

  <!-- Login/Register/Reset popup -->
  <div id="auth-popup" class="popup hidden">
    <div class="popup-overlay"></div>
    <div class="popup-box">
      <div class="tab-header">
        <span id="tab-label">Login</span>
        <button id="close-popup" class="close-btn">&times;</button>
      </div>

      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="login">Login</button>
        <button class="tab-btn" data-tab="register">Register</button>
        <button class="tab-btn" data-tab="reset">Forgot Password</button>
      </div>

      <div id="login" class="tab-content active">
        <form id="login-form">
          <input type="text" placeholder="Username or Email" required />
          <input type="password" placeholder="Password" required />
          <button type="submit">Login</button>
        </form>
      </div>

      <div id="register" class="tab-content">
        <form id="register-form">
          <input type="text" placeholder="Username" required />
          <input type="email" placeholder="Email" required />
          <input type="password" placeholder="Password" required />
          <input type="password" placeholder="Confirm Password" required />
          <button type="submit">Register</button>
        </form>
      </div>

      <div id="reset" class="tab-content">
        <form id="reset-form">
          <input type="password" placeholder="Current Password" required />
          <input type="password" placeholder="New Password" required />
          <input type="password" placeholder="Confirm New Password" required />
          <button type="submit">Reset Password</button>
        </form>
      </div>

      <div class="discord-separator"><span>OR</span></div>

      <button id="discord-login-btn">
        <img src="discord.png" alt="Discord" class="discord-icon" />
        Login with Discord
      </button>
    </div>
  </div>

  <script>
    // Section switching logic
    const sections = {
      home: document.getElementById("home-section"),
      store: document.getElementById("store-section"),
      gambling: document.getElementById("gambling-section"),
    };

    const showSection = (key) => {
      Object.values(sections).forEach((sec) => sec.classList.add("hidden"));
      sections[key].classList.remove("hidden");
    };

    document.getElementById("store-link").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("store");
    });

    document.getElementById("gambling-link").addEventListener("click", (e) => {
      e.preventDefault();
      showSection("gambling");
    });

    document.getElementById("logo-click").addEventListener("click", () => {
      showSection("home");
    });

    // Default to home section
    showSection("home");

    // Auth & Profile System

    const API_URL = 'https://Gamba-Backend.onrender.com/api';

    // Elements
    const loginBtn = document.getElementById('open-auth-popup');
    const profileDisplay = document.getElementById('profile-display');
    const profileNameEl = document.getElementById('profileName');
    const profileBalanceEl = document.getElementById('profileBalance');
    const profileLevelEl = document.getElementById('profileLevel');
    const profileXpEl = document.getElementById('profileXP');
    const profileCashbackEl = document.getElementById('profileCashback');
    const redeemCashbackBtn = document.getElementById('redeemCashbackBtn');
    const logoutBtn = document.getElementById('logoutBtn');

    const authPopup = document.getElementById('auth-popup');
    const closePopupBtn = document.getElementById('close-popup');
    const tabButtons = document.querySelectorAll('.tab-btn');
    const tabContents = document.querySelectorAll('.tab-content');
    const tabLabel = document.getElementById('tab-label');

    const loginForm = document.getElementById('login-form');
    const registerForm = document.getElementById('register-form');
    const resetForm = document.getElementById('reset-form');

    let currentUser = null;
    let profileInterval;

    function formatEuros(value) {
      return value.toFixed(2) + ' â‚¬';
    }

    async function checkSession() {
      try {
        const res = await fetch(`${API_URL}/session`, { credentials: 'include' });
        const data = await res.json();
        if (data.loggedIn) {
          currentUser = data.user;
          showProfile();
          loadProfile();
          if (!profileInterval) {
            profileInterval = setInterval(loadProfile, 5000);
          }
        } else {
          currentUser = null;
          showLogin();
          if (profileInterval) {
            clearInterval(profileInterval);
            profileInterval = null;
          }
        }
      } catch (err) {
        console.error('Session check failed', err);
        showLogin();
      }
    }

    function showLogin() {
      profileDisplay.style.display = 'none';
      loginBtn.style.display = 'inline-block';
    }

    function showProfile() {
      loginBtn.style.display = 'none';
      profileDisplay.style.display = 'flex';
    }

    async function loadProfile() {
      if (!currentUser) return;
      try {
        const res = await fetch(`${API_URL}/profile`, { credentials: 'include' });
        if (!res.ok) throw new Error('Failed to load profile');
        const user = await res.json();

        profileNameEl.textContent = user.username;
        profileBalanceEl.textContent = formatEuros(user.balance);
        profileLevelEl.textContent = user.level;
        profileXpEl.textContent = user.xp;
        profileCashbackEl.textContent = formatEuros(user.cashbackAmount);

        if (user.cashbackAmount >= 5) {
          redeemCashbackBtn.style.display = 'inline-block';
        } else {
          redeemCashbackBtn.style.display = 'none';
        }
      } catch (err) {
        console.error(err);
      }
    }

    async function login(username, password) {
      try {
        const res = await fetch(`${API_URL}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, password }),
        });
        if (res.ok) {
          currentUser = username;
          showProfile();
          loadProfile();
          if (!profileInterval) {
            profileInterval = setInterval(loadProfile, 5000);
          }
          closeAuthPopup();
        } else {
          const data = await res.json();
          alert('Login failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Login request failed');
      }
    }

    async function register(username, email, password, passwordConfirm) {
      if (password !== passwordConfirm) {
        alert("Passwords don't match!");
        return;
      }
      try {
        const res = await fetch(`${API_URL}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ username, email, password }),
        });
        if (res.ok) {
          currentUser = username;
          showProfile();
          loadProfile();
          if (!profileInterval) {
            profileInterval = setInterval(loadProfile, 5000);
          }
          closeAuthPopup();
        } else {
          const data = await res.json();
          alert('Registration failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Registration request failed');
      }
    }

    async function logout() {
      try {
        await fetch(`${API_URL}/logout`, {
          method: 'POST',
          credentials: 'include',
        });
      } catch (err) {
        console.error('Logout request failed', err);
      }
      currentUser = null;
      showLogin();
      if (profileInterval) {
        clearInterval(profileInterval);
        profileInterval = null;
      }
    }

    async function redeemCashback() {
      try {
        const res = await fetch(`${API_URL}/redeem-cashback`, {
          method: 'POST',
          credentials: 'include',
        });
        if (res.ok) {
          alert('Cashback redeemed!');
          loadProfile();
        } else {
          const data = await res.json();
          alert('Redeem failed: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Redeem request failed');
      }
    }

    // Popup controls
    loginBtn.addEventListener('click', () => {
      openAuthPopup();
      showTab('login');
    });

    closePopupBtn.addEventListener('click', closeAuthPopup);
    authPopup.querySelector('.popup-overlay').addEventListener('click', closeAuthPopup);

    tabButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        showTab(btn.dataset.tab);
      });
    });

    function openAuthPopup() {
      authPopup.classList.remove('hidden');
    }

    function closeAuthPopup() {
      authPopup.classList.add('hidden');
      // Reset forms
      loginForm.reset();
      registerForm.reset();
      resetForm.reset();
    }

    function showTab(tabName) {
      tabButtons.forEach(btn => {
        btn.classList.toggle('active', btn.dataset.tab === tabName);
      });
      tabContents.forEach(content => {
        content.classList.toggle('active', content.id === tabName);
      });
      tabLabel.textContent = tabName.charAt(0).toUpperCase() + tabName.slice(1);
    }

    // Form submits
    loginForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = loginForm[0].value.trim();
      const password = loginForm[1].value;
      login(username, password);
    });

    registerForm.addEventListener('submit', e => {
      e.preventDefault();
      const username = registerForm[0].value.trim();
      const email = registerForm[1].value.trim();
      const password = registerForm[2].value;
      const passwordConfirm = registerForm[3].value;
      register(username, email, password, passwordConfirm);
    });

    resetForm.addEventListener('submit', e => {
      e.prevent